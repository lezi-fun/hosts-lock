name: Build and Release Multi-Platform

on:
  release:
    types: [published]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows builds
          - os: windows-latest
            platform: windows
            arch: x64
            artifact_name: network-tools-windows-x64
          - os: windows-latest
            platform: windows  
            arch: x86
            artifact_name: network-tools-windows-x86

          # Linux builds
          - os: ubuntu-latest
            platform: linux
            arch: x64
            artifact_name: network-tools-linux-x64
          - os: ubuntu-latest
            platform: linux
            arch: arm64
            artifact_name: network-tools-linux-arm64
          - os: ubuntu-latest
            platform: linux
            arch: armv7
            artifact_name: network-tools-linux-armv7

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup build environment
      shell: bash
      run: |
        echo "Building for ${{ matrix.platform }} (${{ matrix.arch }})"
        # 使用平台特定的方式创建目录
        if [ "${{ matrix.platform }}" = "windows" ]; then
          # Windows 使用 PowerShell 创建目录
          mkdir -p ${{ matrix.platform }}/build
        else
          mkdir -p ${{ matrix.platform }}/build
        fi

    - name: Install cross-compilation tools (Linux ARM)
      if: matrix.platform == 'linux' && (matrix.arch == 'arm64' || matrix.arch == 'armv7')
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
        sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf

    - name: Configure CMake
      shell: bash
      run: |
        echo "Configuring CMake for ${{ matrix.platform }} (${{ matrix.arch }})"
        
        # Windows configurations
        if [ "${{ matrix.platform }}" = "windows" ]; then
          cd windows
          if [ "${{ matrix.arch }}" = "x86" ]; then
            cmake -B build -A Win32
          else
            cmake -B build -A x64
          fi
        
        # Linux configurations  
        else
          cd linux
          if [ "${{ matrix.arch }}" = "arm64" ]; then
            cmake -B build -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++
          elif [ "${{ matrix.arch }}" = "armv7" ]; then
            cmake -B build -DCMAKE_C_COMPILER=arm-linux-gnueabihf-gcc -DCMAKE_CXX_COMPILER=arm-linux-gnueabihf-g++
          else
            cmake -B build
          fi
        fi

    - name: Build
      shell: bash
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          cd windows
          cmake --build build --config Release
        else
          cd linux
          cmake --build build --config Release -j$(nproc)
        fi

    - name: Create package directory
      shell: bash
      run: |
        # 创建平台特定的目录结构
        mkdir -p "package/${{ matrix.artifact_name }}"
        
        # Copy executables
        if [ "${{ matrix.platform }}" = "windows" ]; then
          cp ${{ matrix.platform }}/build/bin/Release/*.exe "package/${{ matrix.artifact_name }}/" 2>/dev/null || cp ${{ matrix.platform }}/build/bin/*.exe "package/${{ matrix.artifact_name }}/"
        else
          cp ${{ matrix.platform }}/build/bin/* "package/${{ matrix.artifact_name }}/" 2>/dev/null || true
          chmod +x "package/${{ matrix.artifact_name }}"/*
        fi
        
        # 验证文件是否复制成功
        echo "Files in package directory:"
        ls -la "package/${{ matrix.artifact_name }}/" || echo "No files found"
        
        # Add README
        cat > "package/${{ matrix.artifact_name }}/README.md" << EOF
        Network Tools - ${{ matrix.platform }} ${{ matrix.arch }}
        
        Programs included:
        - lock: Add hosts blocking
        - unlock: Remove hosts blocking
        - lunch-lock: Auto-elevate lock tool
        - lunch-unlock: Auto-elevate unlock tool
        
        Build: ${{ github.run_id }}
        Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        EOF

    - name: Create archive
      shell: bash
      run: |
        cd package
        if [ "${{ matrix.platform }}" = "windows" ]; then
          # 确保 7z 可用
          7z a "${{ matrix.artifact_name }}.zip" "${{ matrix.artifact_name }}"/*
        else
          tar -czf "${{ matrix.artifact_name }}.tar.gz" "${{ matrix.artifact_name }}/"
        fi
        
        echo "Created archive:"
        ls -la *.zip *.tar.gz 2>/dev/null || echo "No archives found"

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: package/${{ matrix.artifact_name }}.*
        retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    
    steps:
    - name: Download all build artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        pattern: network-tools-*
        merge-multiple: true

    - name: Display structure of downloaded files
      run: |
        echo "Artifacts structure:"
        find artifacts -type f -name "*.zip" -o -name "*.tar.gz" | sort

    - name: Upload assets to release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Uploading release assets..."
        
        # 安装 GitHub CLI（如果尚未安装）
        if ! command -v gh &> /dev/null; then
          echo "Installing GitHub CLI..."
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh -y
        fi
        
        # 上传所有找到的归档文件
        for asset in artifacts/*/*.*; do
          if [ -f "$asset" ]; then
            asset_name=$(basename "$asset")
            echo "Uploading $asset as $asset_name"
            gh release upload "${{ github.event.release.tag_name }}" "$asset" --clobber
          fi
        done

    - name: Create summary
      run: |
        echo "## Release Assets Created" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The following assets have been uploaded to the release:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        for asset in artifacts/*/*.*; do
          if [ -f "$asset" ]; then
            asset_name=$(basename "$asset")
            echo "- $asset_name" >> $GITHUB_STEP_SUMMARY
          fi
        done
